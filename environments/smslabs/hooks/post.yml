- hosts: login:!builder # won't have a slurm control daemon when in build
  become: no
  gather_facts: false
  tasks:
    - name: Check slurm up after direct deploy
      import_tasks: check_slurm.yml

- hosts: compute:&builder
  become: yes
  gather_facts: false
  tasks:
    - name: Delete cluster-specific config/secrets from compute instance
      file:
        state: absent
        path: "{{ item }}"
      loop:
        - /etc/fstab
        - /etc/sysconfig/slurmd
        - /etc/openstack/clouds.yaml
        - /etc/munge/munge.key

- hosts: localhost
  become: false
  tags: build
  tasks:
    - name: Check Packer build finished
      async_status:
        jid: "{{ packer_run.ansible_job_id }}"
      register: packer_result
      until: packer_result.finished
      retries: 30 # allow 15 mins
      delay: 30
      when: packer_run is defined # allows rerunning post.yml
