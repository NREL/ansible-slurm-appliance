---
# vtest pre.yml

- name: nrel-proto fixes - workaround no internal DNS
  hosts:
    - cluster
  become: true
  tags: etc_hosts
  tasks:
    # - name: Internal DNS workaround - generate /etc/hosts file content
    #   # which interface is used as ansible_host is defined by terraform (see `access_network`) so this is deterministic for multi-rail hosts
    #   set_fact:
    #     etc_hosts_content: |
    #       {% for host in groups['cluster'] %}{{ hostvars[host]['ansible_host'] }} {{ host }}.novalocal {{ host }}
    #       {% endfor %}
    #   run_once: true
    # - name: Internal DNS workaround  - create entries in /etc/hosts for all nodes
    #   blockinfile:
    #     path: /etc/hosts
    #     create: yes
    #     state: present
    #     block: "{{ hostvars[ansible_play_hosts[0]].etc_hosts_content }}"

  - name: Ensure times are correct
    hosts: all
    tags: set_time_on_servers
    become: true
    tasks:
      - include_role:
          name: ansible-role-ntp

  - name: "Set/fix the the ephemeral ssd mounts"
    hosts: compute
    tags: set-ephemeral-mounts
    become: true
    tasks:
      - include_role:
          name: vs-set-ephemeral-mounts

