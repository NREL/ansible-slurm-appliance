---

- hosts: localhost
  gather_facts: false
  become: false
  tags:
    - deprecated
  tasks:
    - fail:
        msg: |
          Variables prefixed secrets_openhpc_* are deprecated - run:
              $ ansible-playbook ansible/adhoc/generate-passwords.yml
          to update these variable names. ** NB: The actual secrets will not be changed.**
      when: "'secrets_openhpc_' in (hostvars[inventory_hostname] | join)"

- hosts: cluster
  gather_facts: false
  tasks:
    - name: Add users
      ansible.builtin.user: "{{ item }}"
      with_items: "{{ appliances_local_users }}"
      become_method: "sudo"
      # Need to change working directory otherwise we try to switch back to non-existent directory.
      become_flags: '-i'
      become: true

- hosts: selinux
  gather_facts: false
  become: yes
  tags:
    - selinux
  tasks:
    - name: Set SELinux state and policy
      ansible.posix.selinux:
        state: "{{ selinux_state }}"
        policy: "{{ selinux_policy }}"
      register: sestatus

- hosts: firewalld
  gather_facts: false
  become: yes
  tags: firewalld
  tasks:
    - import_role:
        name: firewalld

- hosts: fail2ban
  gather_facts: false
  become: yes
  tags: fail2ban
  tasks:
    - import_role:
        name: fail2ban

- hosts:
    - selinux
    - update
  gather_facts: false
  become: yes
  tags:
    - reboot
  tasks:
    - name: Check for pending reboot from package updates
      stat: 
        path: /var/run/reboot-required
      register: update_reboot_required
    - debug:
        msg: "setstatus:{{ (sestatus.reboot_required | default(false)) }} packages: {{ (update_reboot_required.stat.exists | bool) }}"
    - name: Reboot if required from SELinux state change or package upgrades
      reboot:
        post_reboot_delay: 30
      when: (sestatus['reboot_required'] | default(false)) or (update_reboot_required.stat.exists | bool)
    - name: Wait for hosts to be reachable
      wait_for_connection:
        sleep: 15
    - name: update facts
      setup:
      when: (sestatus.changed | default(false)) or (sestatus.reboot_required | default(false))
