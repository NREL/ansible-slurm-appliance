#cloud-config
disable_ec2_metadata: true

mounts:
# nfs_configurations:
{% for nfs_cfg in nfs_configurations %}
  - ["{{ nfs_cfg.nfs_server }}:{{ nfs_cfg.nfs_export }}", "{{ nfs_cfg.nfs_client_mnt_point }}", "nfs", "defaults", "0", "0"]
{% endfor %}

write_files:
{% if groups['etc_hosts'] | length > 0 %}
  - path: /etc/hosts
    encoding: text/plain
    permissions: "0644"
    owner: root:root
    content: |
        127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
        ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

        # BEGIN ANSIBLE MANAGED BLOCK
        {{ etc_hosts_template | indent(width=8, first=false) | trim }}
        # END ANSIBLE MANAGED BLOCK
{% endif %}

  # openhpc_slurm_control_host:
  - path: /etc/sysconfig/slurmd
    encoding: text/plain
    permissions: "0644"
    owner: root:root
    content: SLURMD_OPTIONS='--conf-server {{ openhpc_slurm_control_host }}'

  # openhpc_munge_key:
  - path: /etc/munge/munge.key
    encoding: base64
    permissions: "0400"
    owner: munge:munge
    content: {{ openhpc_munge_key | b64encode}}

{% if groups['rebuild'] | length > 0 %}
  # openhpc_rebuild_clouds:
  - path: /etc/openstack/clouds.yaml
    encoding: text/plain
    permissions: "0400"
    owner: root:root
    content: |
        {{ lookup('file', openhpc_rebuild_clouds) | indent(width=8, first=false) }}
{% endif %}

{% if groups['basic_users'] | length > 0 %}
# basic_users:
# NB: https://cloudinit.readthedocs.io/en/latest/topics/modules.html#users-and-groups states using a str for uid is depreciated and to use an int.
# however /usr/lib/python3.6/site-packages/cloudinit/distros/__init__.py shows it is ignored if NOT a str at v21.1-15.el8_6.3 at least
users:
  - default
{% for user in basic_users_users %}
  - name: {{ user.name }}
    passwd: {{ user.password }}
    uid: '{{ user.uid }}'
    no_create_home: true
{% endfor %}
{% endif %}
