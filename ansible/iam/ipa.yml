---
- name: Install IPA servers
  hosts: ipaserver
  become: true
  gather_facts: true
  tags:
    - ipaserver
  tasks:
  - import_role:
      name: freeipa.ansible_freeipa.ipaserver
    vars:
      state: present
  # - name: allow nfs through firewalld # TODO: check this is ok as NFS is already running
  #   command: >
  #     firewall-cmd
  #     --permanent
  #     --zone="{{ ipaserver_firewalld_zone if ipaserver_firewalld_zone is defined else '' }}"
  #     --add-service={{ item }}
  #   loop:
  #     - nfs
  #     - rpc-bind
  #     - mountd
  #   when:
  #     - ipaserver_setup_firewalld | bool
  #     - "'nfs' in group_names"
  - name: Allow NFS through firewalld # TODO: check this is ok as NFS is already running
    firewalld:
      service: "{{ item }}"
      state: enabled
      permanent: yes
      offline: yes
      immediate: yes
    loop:
      - nfs
      - rpc-bind
      - mountd
    when:
      - ipaserver_setup_firewalld | bool
      - "'nfs' in group_names"
      

- name: Install IPA replicas
  hosts: ipareplicas
  become: true
  gather_facts: true
  tags:
    - ipareplicas
  tasks:
  - import_role:
      name: freeipa.ansible_freeipa.ipareplica
    vars:
      state: present

- name: Install IPA clients
  hosts: ipaclients
  become: true
  gather_facts: true
  tasks:
  - import_role:
      name: freeipa.ansible_freeipa.ipaclient
    vars:
      state: present
      ipaclient_servers: ['alaska-control.novalocal']
    tags: ipaclients # TODO: tags here work, at play level they don't
